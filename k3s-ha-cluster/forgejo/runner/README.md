# Forgejo Runner Helm Chart

Auto-registering Forgejo Actions Runner for Kubernetes.

## Installation Steps

### 1. Register Runner on Forgejo Server

On your Forgejo instance, run:

```bash
forgejo forgejo-cli actions register \
  --secret <some_secret> \
  --name k8s-runner-1 \
  --scope <your-scope>
```

Replace `<your-scope>` with:

- No `--scope`: register for all repos (admin)
- `--scope my-org`: register for organization
- `--scope owner/repo`: register for single repo

### 2. Create Kubernetes Secret

```bash
kubectl create secret generic forgejo-runner-token \
  --from-literal=runner-token=<some_secret> \
  -n forgejo
```

### 3. Deploy Helm Chart

```bash
helm upgrade --install forgejo-runner . -n forgejo
```

The init container will auto-register using the hex secret.

## Configuration

Edit `values.yaml`:

- `runner.instanceUrl`: Your Forgejo instance URL
- `runner.name`: Runner name
- `runner.labels`: Job labels (comma-separated)
- `secret.token`: Must be a 40-char hex string (register on server first)
- `dind.enabled`: Enable Docker-in-Docker sidecar (default: true)
- `dind.image.tag`: Docker DinD version (default: 29.1.5-dind)

## Docker-in-Docker (DinD)

This chart uses Docker-in-Docker to provide Docker functionality to the runner
without mounting the host's Docker socket. The DinD container runs as a
sidecar with the runner and provides:

- Isolated Docker daemon per runner pod
- TLS-secured communication between runner and Docker daemon
- No dependency on host Docker socket
- Better security by running privileged mode only in the DinD container

The runner communicates with DinD via:

- `DOCKER_HOST: tcp://127.0.0.1:2376`
- `DOCKER_TLS_VERIFY: 1`
- `DOCKER_CERT_PATH: /certs/client`

Certificates are automatically generated by the DinD container and shared via
emptyDir volumes.

## Notes

- The `.runner` config file persists in the PVC
- Delete the PVC to force re-registration
- Docker-in-Docker runs as a sidecar container with privileged mode
- DinD storage uses an emptyDir volume (ephemeral)
- If actions doesn't appear for the repository, enable it via API as following

```sh
curl -X PATCH https://<git_address>/api/v1/repos/<username>/<repo_name> \
  -H "Authorization: token <your_token>" \
  -H "Content-Type: application/json" \
  -d '{"has_actions": true}'
```
